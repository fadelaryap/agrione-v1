name: ğŸš€ Deploy to VPS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}

      - name: ğŸ” Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸš€ Deploy to VPS
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            set -e
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸš€ Starting deployment..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Find project directory
            PROJECT_DIR=""
            if [ -d ~/agrione-v1 ]; then
              PROJECT_DIR=~/agrione-v1
            elif [ -d /opt/agrione-v1 ]; then
              PROJECT_DIR=/opt/agrione-v1
            else
              echo "âŒ Project directory not found!"
              echo "   Please clone repository to ~/agrione-v1 or /opt/agrione-v1"
              exit 1
            fi
            
            cd "$PROJECT_DIR"
            echo "ğŸ“ Project directory: $(pwd)"
            
            # Pull latest changes
            echo ""
            echo "ğŸ“¥ Pulling latest changes from GitHub..."
            git fetch origin
            
            # Get current branch or default to main
            CURRENT_BRANCH=$(git branch --show-current 2>/dev/null || echo "main")
            if [ "$CURRENT_BRANCH" = "" ]; then
              CURRENT_BRANCH="main"
            fi
            
            # Try to checkout main or master
            if git show-ref --verify --quiet refs/remotes/origin/main; then
              git checkout -B main origin/main 2>/dev/null || git checkout main
              git reset --hard origin/main
            elif git show-ref --verify --quiet refs/remotes/origin/master; then
              git checkout -B master origin/master 2>/dev/null || git checkout master
              git reset --hard origin/master
            else
              echo "âš ï¸  No main or master branch found, using current branch"
            fi
            
            # Stop existing containers
            echo ""
            echo "ğŸ›‘ Stopping existing containers..."
            docker compose down || true
            
            # Get VPS IP for environment variables
            VPS_IP=$(hostname -I | awk '{print $1}')
            echo "ğŸŒ VPS IP: $VPS_IP"
            
            # Create .env file if it doesn't exist
            if [ ! -f .env ]; then
              echo "ğŸ“ Creating .env file..."
              cat > .env << 'ENVEOF'
POSTGRES_USER=agrione
POSTGRES_PASSWORD=agrione123
POSTGRES_DB=agrione_db
JWT_SECRET=your-super-secret-jwt-key-change-in-production
CSRF_SECRET=your-csrf-secret-key-change-in-production
ENVEOF
              echo "CORS_ORIGIN=http://$VPS_IP:3000" >> .env
              echo "NEXT_PUBLIC_API_URL=http://$VPS_IP:8000" >> .env
            else
              echo "ğŸ“ Updating .env file with VPS IP..."
              # Update CORS_ORIGIN and NEXT_PUBLIC_API_URL if they exist, or add them
              if grep -q "CORS_ORIGIN=" .env; then
                sed -i "s|CORS_ORIGIN=.*|CORS_ORIGIN=http://$VPS_IP:3000|" .env
              else
                echo "CORS_ORIGIN=http://$VPS_IP:3000" >> .env
              fi
              
              if grep -q "NEXT_PUBLIC_API_URL=" .env; then
                sed -i "s|NEXT_PUBLIC_API_URL=.*|NEXT_PUBLIC_API_URL=http://$VPS_IP:8000|" .env
              else
                echo "NEXT_PUBLIC_API_URL=http://$VPS_IP:8000" >> .env
              fi
            fi
            
            # Build containers
            echo ""
            echo "ğŸ”¨ Building containers (this may take a while)..."
            docker compose build --no-cache
            
            # Start containers
            echo ""
            echo "ğŸš€ Starting containers..."
            docker compose up -d
            
            # Wait for services to be ready
            echo ""
            echo "â³ Waiting for services to start (15 seconds)..."
            sleep 15
            
            # Clean up old images
            echo ""
            echo "ğŸ§¹ Cleaning up old Docker images..."
            docker image prune -f
            
            # Show container status
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… Deployment complete!"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            docker compose ps
          ENDSSH

      - name: ğŸ¥ Health Check
        run: |
          sleep 5
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            echo ""
            echo "ğŸ¥ Running health checks..."
            echo ""
            
            # Check containers
            echo "ğŸ“Š Container Status:"
            docker compose ps
            echo ""
            
            # Check backend
            echo "ğŸ” Checking backend (http://localhost:8000/api/health)..."
            if curl -f http://localhost:8000/api/health > /dev/null 2>&1; then
              echo "âœ… Backend is healthy"
            else
              echo "âš ï¸  Backend health check failed (may need more time to start)"
              echo "   Check logs with: docker compose logs backend"
            fi
            
            # Check frontend
            echo ""
            echo "ğŸ” Checking frontend (http://localhost:3000)..."
            if curl -f http://localhost:3000 > /dev/null 2>&1; then
              echo "âœ… Frontend is healthy"
            else
              echo "âš ï¸  Frontend health check failed (may need more time to start)"
              echo "   Check logs with: docker compose logs frontend"
            fi
          ENDSSH
